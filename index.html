<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Fractal Deep - Eldritch Swarm</title>
  <meta name="keywords" content="出水, 出水利樹, 出水 利樹, demimomi, toshiki demizu" />
  <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{overflow:hidden;height:100%;font-family:"Noto Serif JP",serif;background:radial-gradient(ellipse at center,#0a0a0a 0,#000 100%);position:relative;cursor:none}
    html::before{content:"";position:fixed;inset:0;background-image:url('https://raw.githubusercontent.com/demimomi/demimomi/main/sakura.png');background-size:cover;background-position:center;opacity:.12;z-index:-1;animation:breathe 8s ease-in-out infinite}
    @keyframes breathe{0%,100%{opacity:.12;transform:scale(1)}50%{opacity:.18;transform:scale(1.05)}}
    canvas{display:block;position:absolute;inset:0}
    #threeCanvas{z-index:0} #2dCanvas{z-index:1} #particleCanvas{z-index:2}
    .center-om{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:4em;color:rgba(255,255,255,.07);text-shadow:0 0 30px rgba(255,255,255,.15);animation:pulse 6s ease-in-out infinite;pointer-events:none;z-index:2;filter:blur(.5px)}
    @keyframes pulse{0%,100%{opacity:.05;transform:translate(-50%,-50%) scale(1) rotate(0)}50%{opacity:.25;transform:translate(-50%,-50%) scale(1.3) rotate(5deg)}}
    .menu-bar{position:fixed;top:0;width:100%;background:linear-gradient(180deg,rgba(0,0,0,.8) 0,rgba(0,0,0,0) 100%);z-index:1000;font-family:'Segoe UI','Helvetica Neue',sans-serif;font-size:15px;letter-spacing:2px;backdrop-filter:blur(10px);text-align:right;padding:14px 28px;}
    .menu-bar a{margin:0 20px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .4s cubic-bezier(.4,0,.2,1);position:relative;padding:5px 10px}
    .menu-bar a::after{content:"";position:absolute;bottom:0;left:50%;width:0;height:1px;background:rgba(255,255,255,.8);transition:all .4s cubic-bezier(.4,0,.2,1);transform:translateX(-50%)}
    .menu-bar a:hover{color:rgba(255,255,255,.98);text-shadow:0 0 15px rgba(255,255,255,.6);transform:translateY(-2px)}
    .menu-bar a:hover::after{width:100%}

/* --- Hamburger menu (menu only) --- */
.menu-toggle{
  cursor:pointer;
  background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.05));
  border:1px solid rgba(255,255,255,.7);
  border-radius:999px;
  padding:9px 26px;
  color:#ffffff;
  font-family:'Segoe UI','Helvetica Neue',sans-serif;
  font-size:17px;
  letter-spacing:4px;
  display:inline-flex;
  align-items:center;
  gap:14px;
  box-shadow:
    0 0 25px rgba(255,255,255,.45),
    inset 0 0 18px rgba(255,255,255,.15);
  animation: menuPulse 3s ease-in-out infinite;
  transition:all .35s cubic-bezier(.4,0,.2,1);
}
.menu-toggle:hover{
  background:linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.15));
  border-color:#fff;
  text-shadow:0 0 22px rgba(255,255,255,1);
  box-shadow:
    0 0 45px rgba(255,255,255,.85),
    inset 0 0 22px rgba(255,255,255,.25);
  transform:translateY(-3px) scale(1.03);
}

@keyframes menuPulse{
  0%,100%{ box-shadow:0 0 25px rgba(255,255,255,.35), inset 0 0 18px rgba(255,255,255,.12); }
  50%{ box-shadow:0 0 40px rgba(255,255,255,.75), inset 0 0 26px rgba(255,255,255,.22); }
}

.menu-links{display:none;
  margin-top:16px;text-align:right;}
.menu-bar.is-open .menu-links{
  display:block;
}
.menu-label{opacity:.9}

    .izumi-logo{position:absolute;right:25px;bottom:25px;display:flex;align-items:center;font-size:1em;font-family:'Sawarabi Mincho',serif;color:rgba(255,255,255,.2);z-index:3;pointer-events:none;text-shadow:0 0 8px rgba(255,255,255,.15);opacity:0;animation:fadeInLogo 3s ease-in-out 1s forwards}
    .izumi-logo img{width:20px;height:20px;margin-left:8px;opacity:.6;filter:drop-shadow(0 0 3px rgba(255,255,255,.2));animation:rotate 20s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    @keyframes fadeInLogo{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
    .custom-cursor{position:fixed;width:20px;height:20px;border:2px solid rgba(255,255,255,.6);border-radius:50%;pointer-events:none;z-index:9999;transition:all .1s ease;mix-blend-mode:difference}
    .code-block{position:absolute;bottom:80px;left:30px;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:15px;font-family:'Courier New',monospace;font-size:11px;color:#b0b0b0;max-width:400px;z-index:3;opacity:0;animation:fadeInCode 2s ease-in-out 2s forwards;backdrop-filter:blur(10px)}
    @keyframes fadeInCode{0%{opacity:0;transform:translateX(-20px)}100%{opacity:.8;transform:translateX(0)}}
    .code-block code{display:block;line-height:1.6}
    .hud{position:fixed;left:14px;top:58px;font:10px/1.2 'Courier New',monospace;color:rgba(200,255,220,.55);z-index:4;opacity:.0;animation:fadeHud 2s ease 3s forwards}
    @keyframes fadeHud{to{opacity:.7}}
    .hint{position:fixed;right:16px;top:58px;font:10px/1 'Courier New',monospace;color:rgba(255,255,255,.45);z-index:4;opacity:.0;animation:fadeHud 2s ease 4s forwards}
  </style>
  <link rel="icon" href="https://raw.githubusercontent.com/demimomi/demimomi/refs/heads/main/inyou2.png" type="image/png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/demimomi/demimomi/refs/heads/main/inyou2.png">
</head>
<body>
  <div class="menu-bar" id="topMenu" aria-label="Site Menu">
    <button class="menu-toggle" id="menuToggle" type="button" aria-controls="menuLinks" aria-expanded="false">
      ☰ <span class="menu-label">Menu</span>
    </button>
    <div class="menu-links" id="menuLinks">
      <a href="https://huggingface.co/demimomi/llm-jp-3-13b-finetune-ex" target="_blank">LLM2024</a>
      <a href="https://huggingface.co/demimomi/U-Tokyo-2025Basic" target="_blank">LLM2025</a>
      <a href="https://huggingface.co/demimomi/demimomi44taomax-qwen3-4b-structured-output-lora" target="_blank">LLM2026</a>
      <a href="https://youtu.be/K-sH70U4hX4" target="_blank">Bridge</a>
      <a href="https://jglobal.jst.go.jp/en/detail?JGLOBAL_ID=202503000973003453" target="_blank">TokyoBus PJ</a>
      <a href="https://www.j-platpat.inpit.go.jp/c1801/PU/JP-2025-044252/11/ja" target="_blank">AI</a>
      <a href="https://www.softbank.jp/sbnews/entry/20240304_02" target="_blank">CatBus</a>
      <a href="https://wandb.ai/toshiki-demizu-monet-technologies-/pytorch-intro/reports/Hello-World---VmlldzoxNDk2Nzg2OQ?accessToken=u00skj0dq557zsj2g3u8jhr2six6iylpf7kd65hqw5gjnwsoopld2pgqufiw4atq" target="_blank">DB</a>
    </div>
  </div>


<canvas id="threeCanvas"></canvas>
  <canvas id="2dCanvas"></canvas>
  <canvas id="particleCanvas"></canvas>

  <div class="center-om">ॐ</div>
  <div class="custom-cursor"></div>

  <div class="izumi-logo">
    出水の桜
    <img src="https://raw.githubusercontent.com/demimomi/demimomi/refs/heads/main/sakura.png" alt="sakura">
  </div>

  <div class="code-block">
    <code># Load model directly<br>from transformers import AutoModel<br>model = AutoModel.from_pretrained(<br>&nbsp;&nbsp;"demimomi/llm-jp-3-13b-finetune-ex"<br>)</code>
  </div>

  <div class="hud" id="hud">SWARM: 0 | RIFTS: 0 | HUM: OFF</div>
  <div class="hint">click = hum toggle / sigil</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script>
    // ---------- Cursor ----------
    const cursor = document.querySelector('.custom-cursor');
    addEventListener('mousemove', e => {
      cursor.style.left = e.clientX + 'px';
      cursor.style.top = e.clientY + 'px';
    });

    // ---------- Three.js ----------
    const threeCanvas = document.getElementById('threeCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha:true, antialias:true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const geometry = new THREE.TorusKnotGeometry(1, 0.3, 150, 20);
    const material = new THREE.MeshStandardMaterial({
      color: 0x8844ff, emissive: 0x220022, roughness: 0.2, metalness: 0.9, wireframe:false
    });
    const torusKnot = new THREE.Mesh(geometry, material);
    scene.add(torusKnot);

    const ambient = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambient);
    const point1 = new THREE.PointLight(0xff88ff, 1.5); point1.position.set(5,5,5); scene.add(point1);
    const point2 = new THREE.PointLight(0x88ffff, 1.0); point2.position.set(-5,-5,3); scene.add(point2);

    function resizeRenderer(){
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      canvas2D.width = innerWidth; canvas2D.height = innerHeight;
      particleCanvas.width = innerWidth; particleCanvas.height = innerHeight;
    }
    addEventListener('resize', resizeRenderer);

    // ---------- 2D + Particles ----------
    const canvas2D = document.getElementById('2dCanvas');
    const ctx = canvas2D.getContext('2d');
    const particleCanvas = document.getElementById('particleCanvas');
    const pCtx = particleCanvas.getContext('2d');
    resizeRenderer();

    // Sakura drift
    const sakuraParticles = [];
    for(let i=0;i<30;i++){
      sakuraParticles.push({
        x: Math.random()*particleCanvas.width,
        y: Math.random()*particleCanvas.height - particleCanvas.height,
        speed: 0.5 + Math.random(),
        size: 3 + Math.random()*4,
        drift: Math.random()*2 - 1,
        opacity: 0.3 + Math.random()*0.4
      });
    }

    // ---------- Eldritch Swarm ----------
    const mouse = { x: innerWidth/2, y: innerHeight/2, tx: innerWidth/2, ty: innerHeight/2 };
    canvas2D.addEventListener('mousemove', e => { mouse.tx=e.clientX; mouse.ty=e.clientY; });
    let time = 0, chaosMode = false;

    // Sigil bursts & rifts
    const sigils = []; // ephemeral ritual circles that attract swarm
    const rifts  = []; // portals that spawn/consume creatures

    canvas2D.addEventListener('click', (e)=>{
      toggleHum(); // first click -> audio start, then toggle
      // spawn sigil
      sigils.push({
        x:e.clientX, y:e.clientY, r:8, life:1, spin: Math.random()*Math.PI*2,
        glyphs: Array.from({length:8}, (_,i)=>i)
      });
    });

    // WebAudio hum (subtle)
    let audioCtx=null, humNode=null, humOn=false;
    function toggleHum(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type='sawtooth';
        o.frequency.setValueAtTime(48, audioCtx.currentTime); // 48Hz base
        const lfo = audioCtx.createOscillator();
        const lfoGain = audioCtx.createGain();
        lfo.frequency.value = 0.15;
        lfoGain.gain.value = 12;
        lfo.connect(lfoGain).connect(o.frequency);
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 220;
        g.gain.value = 0.0001; // start muted
        o.connect(filter).connect(g).connect(audioCtx.destination);
        o.start(); lfo.start();
        humNode={o,g,filter}; humOn=false;
      }
      humOn=!humOn;
      const target = humOn?0.015:0.0001;
      humNode.g.gain.cancelScheduledValues(0);
      humNode.g.gain.linearRampToValueAtTime(target, audioCtx.currentTime+0.3);
      updateHUD();
    }

    // Creature (evolved from single GeometricCreature)
    class GeometricCreature {
      constructor(x=Math.random()*innerWidth, y=Math.random()*innerHeight){
        this.x=x; this.y=y;
        this.vx=Math.cos(Math.random()*Math.PI*2)*0.6;
        this.vy=Math.sin(Math.random()*Math.PI*2)*0.6;
        this.angle=Math.random()*Math.PI*2;
        this.size= 48+Math.random()*22;
        this.eyePhase=Math.random()*Math.PI*2;
        this.pulse= Math.random()*Math.PI*2;
        this.tentacles=[];
        for(let i=0;i<8;i++){
          this.tentacles.push({angle:(i*Math.PI*2)/8,length:40+Math.random()*30,segments:12,phase:Math.random()*Math.PI*2,wiggle:0.5+Math.random()*0.6});
        }
        this.hue = 140 + Math.random()*40; // greenish
        this.life = 1; // for fade in/out
        this.sym = ['☯','で','☯','☆','☯','水'];
      }

      update(neighbors){
        // Boids-ish: separation, alignment, cohesion
        let ax=0, ay=0, count=0, avx=0, avy=0, cx=0, cy=0;
        neighbors.forEach(n=>{
          const dx=this.x-n.x, dy=this.y-n.y;
          const d2=dx*dx+dy*dy;
          if(d2<1) return;
          if(d2<120*120){
            count++;
            avx+=n.vx; avy+=n.vy;
            cx+=n.x; cy+=n.y;
            if(d2<50*50){ ax+=dx/d2*80; ay+=dy/d2*80; } // separation
          }
        });
        if(count){
          // alignment
          this.vx += (avx/count - this.vx)*0.02;
          this.vy += (avy/count - this.vy)*0.02;
          // cohesion
          this.vx += ((cx/count - this.x)*0.0008);
          this.vy += ((cy/count - this.y)*0.0008);
        }

        // attracted to nearest active sigil
        if(sigils.length){
          const s = sigils[ sigils.length-1 ];
          const dx=s.x-this.x, dy=s.y-this.y;
          const d=Math.hypot(dx,dy)+1;
          const f = Math.min(0.06, 140/(d*d));
          this.vx += dx*f; this.vy += dy*f;
        }

        // mouse repulsion (spotlight fear)
        const mdx=this.x-mouse.x, mdy=this.y-mouse.y;
        const md2=mdx*mdx+mdy*mdy;
        if(md2<180*180){
          const f=Math.min(1.2, 260/(md2+1));
          this.vx += mdx*f; this.vy += mdy*f;
        }

        // gentle wander + chaos boost
        const speedBase = chaosMode ? 1.2 : 0.8;
        this.vx += (Math.random()-0.5)*0.06;
        this.vy += (Math.random()-0.5)*0.06;

        // limit speed
        const sp=Math.hypot(this.vx,this.vy);
        const maxS = chaosMode ? 2.0 : 1.4;
        if(sp>maxS){ this.vx=this.vx/sp*maxS; this.vy=this.vy/sp*maxS; }

        this.x+=this.vx; this.y+=this.vy;

        // wrap screen
        const pad=120;
        if(this.x<-pad) this.x=innerWidth+pad;
        if(this.x>innerWidth+pad) this.x=-pad;
        if(this.y<-pad) this.y=innerHeight+pad;
        if(this.y>innerHeight+pad) this.y=-pad;

        this.eyePhase += 0.02;
        this.pulse += 0.03;
        // slight drift of hue in chaos
        if(chaosMode) this.hue += Math.sin(time*0.01)*0.04;
      }

      draw(ctx,t){
        ctx.save(); ctx.translate(this.x,this.y);

        // tentacles
        this.tentacles.forEach(tl=>{
          ctx.strokeStyle=`hsla(${this.hue},70%,70%,0.18)`;
          ctx.lineWidth=3; ctx.beginPath();
          for(let i=0;i<=tl.segments;i++){
            const u=i/tl.segments;
            const ang=tl.angle + Math.sin(t*0.02+tl.phase+i*0.3)*tl.wiggle;
            const dist=tl.length*u;
            const x=Math.cos(ang)*dist, y=Math.sin(ang)*dist;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            if(i>0 && i%3===0){
              ctx.fillStyle=`hsla(${this.hue},80%,80%,${0.2+Math.sin(t*0.05+i)*0.1})`;
              ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill();
            }
          }
          ctx.stroke();
        });

        // body glow
        const pulseSize = this.size*(1+Math.sin(this.pulse)*0.15);
        const g=ctx.createRadialGradient(0,0,0,0,0,pulseSize);
        g.addColorStop(0,`hsla(${this.hue},60%,70%,0.10)`);
        g.addColorStop(0.5,`hsla(${this.hue},60%,60%,0.05)`);
        g.addColorStop(1,`hsla(${this.hue},60%,60%,0)`);
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,pulseSize,0,Math.PI*2); ctx.fill();

        // main polygonal shell
        ctx.strokeStyle=`hsla(${this.hue},60%,75%,0.35)`;
        ctx.lineWidth=2; ctx.beginPath();
        for(let i=0;i<6;i++){
          const a=(i*Math.PI*2)/6 + time*0.01;
          const r=this.size*0.5 + Math.sin(time*0.05+i)*5;
          const x=Math.cos(a)*r, y=Math.sin(a)*r;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath(); ctx.stroke();
        ctx.fillStyle=`hsla(${this.hue},40%,55%,0.06)`; ctx.fill();

        // eyes
        const eyePos=[{x:-12,y:-8},{x:12,y:-8},{x:0,y:8}];
        eyePos.forEach((p,idx)=>{
          const s=6+Math.sin(this.eyePhase+idx)*2;
          ctx.fillStyle='rgba(255,255,255,0.15)';
          ctx.beginPath(); ctx.arc(p.x,p.y,s,0,Math.PI*2); ctx.fill();

          const dx=mouse.x-this.x, dy=mouse.y-this.y;
          const a=Math.atan2(dy,dx), d=s*0.35;
          const px=p.x+Math.cos(a)*d, py=p.y+Math.sin(a)*d;
          ctx.shadowColor=`hsla(${this.hue},80%,75%,0.9)`; ctx.shadowBlur=8;
          ctx.fillStyle=`hsla(${this.hue},80%,75%,0.7)`;
          ctx.beginPath(); ctx.arc(px,py,s*0.4,0,Math.PI*2); ctx.fill();
          ctx.shadowBlur=0;
          // specular dot
          ctx.fillStyle='rgba(255,255,255,0.9)';
          ctx.beginPath(); ctx.arc(px-1,py-1,s*0.18,0,Math.PI*2); ctx.fill();
        });

        // orbiting symbols
        for(let i=0;i<6;i++){
          const a=(i*Math.PI*2)/6 + time*0.008;
          const d=this.size*0.7;
          const x=Math.cos(a)*d, y=Math.sin(a)*d;
          ctx.fillStyle=`hsla(${this.hue},70%,80%,${0.18+Math.sin(time*0.05+i)*0.1})`;
          ctx.font='12px serif'; ctx.fillText(this.sym[i], x-6, y+4);
        }

        ctx.restore();
      }
    }

    const swarm = [];
    const MAX_SWARM_BASE = 10;
    for(let i=0;i<MAX_SWARM_BASE;i++) swarm.push(new GeometricCreature());

    function updateHUD(){
      const hud=document.getElementById('hud');
      hud.textContent=`SWARM: ${swarm.length} | RIFTS: ${rifts.length} | HUM: ${humOn?'ON':'OFF'}`;
    }

    // ---------- Rifts ----------
    function maybeOpenRift(){
      if(Math.random()<0.006 || (chaosMode && Math.random()<0.012)){
        const x=Math.random()*innerWidth, y=Math.random()*innerHeight;
        rifts.push({x,y,r:8,life:1,spin:Math.random()*Math.PI*2, sign: Math.random()<0.5?1:-1});
        // spawn a creature
        if(swarm.length< (chaosMode? 26: MAX_SWARM_BASE+6)){
          swarm.push(new GeometricCreature(x+Math.random()*20-10, y+Math.random()*20-10));
        }else{
          // or consume one
          swarm.splice((Math.random()*swarm.length)|0,1);
        }
        updateHUD();
      }
    }

    // ---------- Sakura & Effects ----------
    function drawSakura(){
      pCtx.clearRect(0,0,particleCanvas.width, particleCanvas.height);
      sakuraParticles.forEach(p=>{
        p.y+=p.speed; p.x += Math.sin(p.y*0.01)*p.drift;
        if(p.y>particleCanvas.height){ p.y=-20; p.x=Math.random()*particleCanvas.width; }
        pCtx.save(); pCtx.translate(p.x,p.y); pCtx.rotate(p.y*0.01);
        pCtx.fillStyle=`rgba(255,200,220,${p.opacity})`;
        pCtx.beginPath();
        for(let i=0;i<5;i++){
          const a=(i*2*Math.PI)/5; const x=p.size*Math.cos(a), y=p.size*Math.sin(a);
          if(i===0) pCtx.moveTo(x,y); else pCtx.lineTo(x,y);
        }
        pCtx.closePath(); pCtx.fill(); pCtx.restore();
      });
    }

    // background fade
    function drawBackground(){
      ctx.fillStyle = chaosMode ? 'rgba(0,0,0,0.015)' : 'rgba(0,0,0,0.05)';
      ctx.fillRect(0,0,canvas2D.width, canvas2D.height);
    }

    // smoke / spiral / eye as before (kept lightweight)
    function drawSmokeDragon(t){
      for(let i=0;i<380;i++){
        const angle=i*0.028 + t*0.0015;
        const radius=150 + Math.sin(t*0.003+i)*40;
        const x=canvas2D.width/2 + radius*Math.cos(angle);
        const y=canvas2D.height/2 + radius*Math.sin(angle*1.15);
        ctx.beginPath(); ctx.arc(x,y,1.6,0,Math.PI*2);
        const alpha = Math.sin(i + t*0.005)*0.04 + 0.04;
        ctx.fillStyle=`rgba(255,255,255,${alpha})`; ctx.fill();
      }
    }
    function drawFractalSpiral(cx,cy,t){
      for(let i=0;i<100;i++){
        const a=i*0.25 + t*0.0018;
        const r=12*Math.sqrt(i)*(1+Math.sin(t*0.002+i*0.15)*0.3);
        const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a);
        ctx.beginPath(); ctx.arc(x,y,1.5,0,Math.PI*2);
        ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fill();
      }
    }
    function drawDragonEye(){
      mouse.x += (mouse.tx-mouse.x)*0.1;
      mouse.y += (mouse.ty-mouse.y)*0.1;
      ctx.beginPath(); ctx.arc(mouse.x, mouse.y, 12, 0, Math.PI*2);
      ctx.fillStyle='rgba(255,255,255,0.08)';
      ctx.shadowColor='white'; ctx.shadowBlur=25; ctx.fill(); ctx.shadowBlur=0;
    }

    // Sigils & Rifts rendering
    function drawSigilsAndRifts(){
      // sigils
      for(let i=sigils.length-1;i>=0;i--){
        const s=sigils[i];
        s.life -= 0.012; s.r += 1.2; s.spin += 0.03;
        if(s.life<=0){ sigils.splice(i,1); continue; }
        ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.spin);
        ctx.globalCompositeOperation='lighter';
        ctx.strokeStyle=`rgba(200,255,230,${0.35*s.life})`;
        ctx.lineWidth=1.5;
        ctx.beginPath(); ctx.arc(0,0,s.r,0,Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.arc(0,0,s.r*0.5,0,Math.PI*2); ctx.stroke();
        ctx.fillStyle=`rgba(180,255,220,${0.25*s.life})`;
        for(const i2 of s.glyphs){
          const a=(i2*Math.PI*2)/s.glyphs.length;
          const x=Math.cos(a)*s.r*0.8, y=Math.sin(a)*s.r*0.8;
          ctx.fillText(['☯','で','☯','☆','◯','水'][i2%6], x-4,y+4);
        }
        ctx.restore();
      }
      // rifts
      for(let i=rifts.length-1;i>=0;i--){
        const r=rifts[i];
        r.life -= 0.01; r.r += 0.9; r.spin += 0.02*r.sign;
        if(r.life<=0){ rifts.splice(i,1); continue; }
        ctx.save(); ctx.translate(r.x,r.y); ctx.rotate(r.spin);
        const grd=ctx.createRadialGradient(0,0,0,0,0,r.r*1.2);
        grd.addColorStop(0,`rgba(100,255,200,0.18)`);
        grd.addColorStop(1,`rgba(100,255,200,0)`);
        ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(0,0,r.r*1.2,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle=`rgba(180,255,220,0.35)`; ctx.setLineDash([6,4]);
        ctx.beginPath();
        for(let k=0;k<3;k++){
          const a=(k*Math.PI*2)/3;
          ctx.moveTo(0,0); ctx.lineTo(Math.cos(a)*r.r, Math.sin(a)*r.r);
        }
        ctx.stroke(); ctx.setLineDash([]);
        ctx.restore();
      }
    }

    // ---------- Animation ----------
    function animate(){
      time++;

      if(time===1500){ // ~25s
        chaosMode=true; material.wireframe=true;
        // surge more creatures
        for(let i=0;i<6;i++) swarm.push(new GeometricCreature(innerWidth/2, innerHeight/2));
        updateHUD();
      }

      // Three.js torus motion
      const targetRotX = (mouse.y/innerHeight - 0.5)*0.5;
      const targetRotY = (mouse.x/innerWidth - 0.5)*0.5;
      torusKnot.rotation.x += (targetRotX - torusKnot.rotation.x)*0.05 + 0.003;
      torusKnot.rotation.y += (targetRotY - torusKnot.rotation.y)*0.05 + 0.005;
      material.emissiveIntensity = chaosMode?1.5:0.3;
      material.color.set(chaosMode?0xff3366:0x8844ff);
      point1.position.x = Math.sin(time*0.001)*8;
      point1.position.y = Math.cos(time*0.0015)*8;
      renderer.render(scene,camera);

      // 2D layers
      drawBackground();
      drawFractalSpiral(innerWidth/2, innerHeight/2, time);
      drawSmokeDragon(time);
      drawDragonEye();

      // swarm update/draw
      for(let i=0;i<swarm.length;i++){
        const c=swarm[i];
        // provide a small neighbor set (performance)
        const neighbors=[];
        for(let j=0;j<6;j++){
          const k=(i+j*3)%swarm.length;
          if(k!==i) neighbors.push(swarm[k]);
        }
        c.update(neighbors);
        c.draw(ctx,time);
      }

      // ritual & portals
      drawSigilsAndRifts();
      maybeOpenRift();

      // sakura + front effects
      drawSakura();

      requestAnimationFrame(animate);
    }

    // ---------- Utility ----------
    function lerp(a,b,t){return a+(b-a)*t;}

    // start
    resizeRenderer();
    updateHUD();
    animate();
  
    // ---------- Menu (Hamburger) ----------
    (function(){
      const menu = document.getElementById('topMenu');
      const btn  = document.getElementById('menuToggle');
      const links= document.getElementById('menuLinks');
      if(!menu || !btn || !links) return;

      function setOpen(open){
        menu.classList.toggle('is-open', open);
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }

      btn.addEventListener('click', ()=>{
        const open = !menu.classList.contains('is-open');
        setOpen(open);
      });

      // close when a link is clicked
      links.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a) setOpen(false);
      });

      // close on ESC
      addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') setOpen(false);
      });
    })();

  </script>
</body>
</html>



